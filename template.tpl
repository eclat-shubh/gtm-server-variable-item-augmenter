___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "MACRO",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Item Array Augmenter - Shopify ID",
  "brand": {
    "id": "github.com_eclat-shubh",
    "displayName": "eclat-shubh",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Augments the 'items' array. Overwrites 'item_id' with a custom Shopify format (shopify_MARKET_prod_var) and adds 'parent_product_id'.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "itemsArray",
    "displayName": "Items Array",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "marketCode",
    "displayName": "Market Code (e.g., GB) Use ISO codes only",
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_SERVER___

// Require the necessary GTM APIs
const getType = require('getType');

// Get the data from the template fields
const originalItems = data.itemsArray;
const market = data.marketCode || ''; // Get the market code, or default to an empty string

// Check if it's a valid array
if (getType(originalItems) !== 'array') {
  return [];
}

// Transform the array
const formattedItems = originalItems.map(item => {

  // Check if the item is an object with valid string IDs
  if (getType(item) === 'object' && 
      getType(item.item_id) === 'string' && 
      getType(item.item_variant) === 'string') {
    
    const productId = item.item_id;
    const variantId = item.item_variant;
    
    // Build the new ID. 
    // If market is 'GB', result is 'shopify_GB_123_456'
    // If market is blank, result is 'shopify__123_456' (which is fine)
    item.item_id = 'shopify_' + market + '_' + productId + '_' + variantId;
    
    // Also add the parent_product_id as a custom dimension
    item.item_group_id = productId;
  }
  
  // Return the modified item
  return item;
});

// Return the final formatted array
return formattedItems;


___TESTS___

scenarios: []


___NOTES___

Created on 04/11/2025, 15:00:53


